<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>

<head>
  <title>Raphael Vallat, PhD</title>
  <meta charset="utf-8" />
  <meta name="description" content="Raphael Vallat, PhD" />
  <meta name="author" content="Raphael Vallat, PhD" />
  <meta name="keywords" content="Raphael Vallat, raphaelvallat, Lyon Neuroscience Research Center, DYCOG, Lyon Neuroscience, Sleep research, Dream research" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/academicons.css" />
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="assets/css/sunburst.css">
  <script src="assets/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  <!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-118198513-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-118198513-1');
  </script>

</head>

<body>

  <!-- Header -->
  <section id="header">
    <header>
      <!-- <span class="image avatar"><img src="images/avatar.jpg" alt="" /></span> -->
      <h1 id="logo"><a href="#">Raphael Vallat</a></h1>
      <p>Postdoctoral fellow<br>Walker Lab, U.C Berkeley</p>
    </header>
    <nav id="nav">
      <ul>
        <li><a href="index.html#one">About</a></li>
        <li><a href="index.html#two">News</a></li>
        <li><a href="index.html#three">Academics</a></li>
        <li><a href="index.html#four">Publications</a></li>
        <li><a href="index.html#five">Softwares</a></li>
        <li><a href="index.html#six" class="active">Guides</a></li>
      </ul>
    </nav>
    <footer>
      <ul class="icons">
        <li><a href="https://github.com/raphaelvallat" class="icon fa-github" target="_blank"><span class="label">Github</span></a></li>
        <li><a href="mailto:raphaelvallat9@gmail.com" class="icon fa-envelope"><span class="label">Email</span></a></li>
        <li><a href="https://scholar.google.fr/citations?user=XH8IG2UAAAAJ" style="border:none" class="ai ai-google-scholar ai-1x" target="_blank"></a></li>
        <li><a href="https://www.researchgate.net/profile/Raphael_Vallat2" style="border:none" class="ai ai-researchgate ai-1x" target="_blank"></a></li>
      </ul>
    </footer>
  </section>

  <!-- Wrapper -->
  <div id="wrapper">

    <!-- Main -->
    <div id="main">

      <div class="container">


        <header>
          <h3>Compute the average bandpower of an EEG signal.</h3>
        </header>

        <p align="justify">Welcome to this first tutorial on EEG signal processing in Python!
          <br><br> In this first part, we are going to see how to compute the <b>average power of a signal in a specific frequency range</b>.</p>

          <hr />

          <h4>Foreword</h4>

          <p align="justify">One of the most widely used method to analyze EEG data is to decompose the signal into functionally distinct frequency bands, such as <a href="https://en.wikipedia.org/wiki/Delta_wave" target="_blank">delta</a> (0.5–4 Hz), <a href="https://en.wikipedia.org/wiki/Theta_wave" target="_blank">theta</a> (4–7 Hz), <a href="https://en.wikipedia.org/wiki/Alpha_wave" target="_blank">alpha</a> (8–12 Hz), <a href="https://en.wikipedia.org/wiki/Beta_wave" target="_blank">beta</a> (12–30 Hz), and <a href="https://en.wikipedia.org/wiki/Gamma_wave" target="_blank">gamma</a> (30–100 Hz).
          This implies the decomposition of the EEG signal into frequency components, which is commonly achieved through <a href="https://en.wikipedia.org/wiki/Fourier_transform" target="_blank">Fourier transforms</a>.<br></p>

        <span class="image fit"><img src="images/tutorials/bandpower/brain_waves.png" alt="Brain waves"/></span>

        <p align="justify">While several type of analyses can be performed with frequency bands, I am going to focus here on a very simple one: the <b>average band power</b>. For instance, if you are looking at EEG sleep data and are interested in slow-wave sleep (N3 sleep),
          which are characterized by high delta activity, you might want to know <i>"what is the average power of the delta frequency band during slow-wave sleep?"</i>.
          <br><br>Typically, higher delta values indicate a higher amount of slow-waves and are associated with increased subjective sleep quality (sleep is perceived as more "refreshing"). Using that simple metric, it then becomes easy to compare objective sleep quality
          between groups (e.g. insomniacs versus control, old vs young...) or within individuals.</p>

        <hr />

        <h4>Data loading</h4>

        <p align="justify">For the sake of this tutorial, please find below a 30-seconds extract of real slow-wave sleep from one young individual. The sampling frequency is 100 Hz and the channel is F3.</p>

        <ul class="actions" align="center">
          <li><a href="images/tutorials/bandpower/data.txt" class="button special icon fa-download" download>Download the raw data (.txt) for this tutorial</a></li>
        </ul>

        <p align="justify">Time to open your favorite Python editor! Loading the data is fairly easy:</p>

        <pre><code class="python">import numpy as np
data = np.loadtxt('data.txt')</code></pre>

        <p align="justify">Let's take a look at the data:</p>

        <pre><code class="python">import matplotlib.pyplot as plt
import seaborn as sns
sns.set(font_scale=1.2)

# Define sampling frequency and time vector
sf = 100.
time = np.arange(data.size) / sf

# Plot the signal
fig, ax = plt.subplots(1, 1, figsize=(12, 4))
plt.plot(time, data, lw=1.5, color='k')
plt.xlabel('Time (seconds)')
plt.ylabel('Voltage')
plt.xlim([time.min(), time.max()])
plt.title('N3 sleep EEG data (F3)')
sns.despine()
</code></pre>

        <span class="image fit"><img src="images/tutorials/bandpower/signal.png" alt="" /></span>

        <hr />

        <h4>Computing the power spectral density</h4>

        <p align="justify">Now let's say that you want to compute the average power of the Delta frequency band (0.5 - 4.5 Hz). To do that, we first need to compute an estimate of the <a href="https://en.wikipedia.org/wiki/Spectral_density" target="_blank">power spectral density</a>.
          The most widely-used method to do that is the <a href="https://en.wikipedia.org/wiki/Welch%27s_method" target="_blank">Welch's periodogram</a>, which consists in squaring and averaging consecutive Fourier transform of small windows of the signal,
          with or without overlapping. The Welch's method improves the accuracy of the classic periodogram and as such is sometimes called a modified periodogram.
          <br><br> Because the lower limit of the delta band is 0.5 Hz, it means that a full cycle is completed every two seconds (= 1 / 0.5). To get a sufficient resolution, we need at least two full cycles, i.e. a window length of 4 seconds.
        </p>

        <pre><code class="python">from scipy import signal

# Define window length (4 seconds)
nperseg = 4 * sf
freqs, psd = signal.welch(data, sf, nperseg=nperseg, scaling='density')

# Plot the power spectrum
sns.set(font_scale=1.2, style='white')
plt.figure(figsize=(8, 4))
plt.plot(freqs, psd, color='k', lw=2)
plt.xlabel('Frequency (Hz)')
plt.ylabel('Power spectral density (V^2 / Hz)')
plt.ylim([0, psd.max() * 1.1])
plt.title("Welch's periodogram")
plt.xlim([0, 20])
sns.despine()
</code></pre>

        <span class="image fit"><img src="images/tutorials/bandpower/psd.png" alt="" /></span>


        <p align="justify">The <code>freqs</code> vector contains the x-axis (frequency bins) and the <code>psd</code> vector contains the y-axis (power spectral density). The units of the power spectral density, when working with EEG data, is Volts-squared per Hz (V^2/Hz).</p>

        <ul class="feature-icons">
          <li class="fa-exclamation-triangle">Note that the maximum value of the x-axis is always half the sampling frequency, which corresponds to the <a href="https://en.wikipedia.org/wiki/Nyquist_frequency" target="_blank">Nyquist frequency</a>.</li>
        </ul>

        <hr />

        <h4>Defining the delta band</h4>

        <p align="justify">Now, before computing the average delta bandpower, we need to find the frequency bins that intersect our delta band (defined by the range 0.5 to 4 Hz).</p>

        <pre><code class="python"># Define delta lower and upper limits
low, high = 0.5, 4
idx_min = np.argmax(freqs > low) - 1
idx_max = np.argmax(freqs > high) - 1
idx_delta = np.zeros(dtype=bool, shape=freqs.shape)
idx_delta[idx_min:idx_max] = True

# Plot the power spectral density and fill the area comprising the delta band
plt.figure(figsize=(8, 4))
plt.plot(freqs, psd, lw=2, color='k')

# plt.fill_between does not count the first and last True values of idx_delta
idx_fill = idx_delta.copy()
idx_fill[idx_min:idx_max+1]= True
plt.fill_between(freqs, psd, where=idx_fill)

# Axes and labels
plt.xlabel('Frequency (Hz)')
plt.ylabel('Power spectral density (V^2 / Hz)')
plt.xlim([0, 10])
plt.ylim([0, psd.max() * 1.1])
plt.title("Welch's periodogram")
sns.despine()
</code></pre>

        <span class="image fit"><img src="images/tutorials/bandpower/psd_area.png" alt="" /></span>


        <hr />

        <h4>Average band power</h4>

        <p align="justify">The absolute delta power is equals to the blue area of the previous plot. As there is no closed-form formula to integrate this area, we need to approximate it by using the <a href="https://en.wikipedia.org/wiki/Trapezoidal_rule" target="_blank">composite trapezoidal rule</a>.
          The idea behind it is actually very simple: we decompose this area into several trapezoids and then sum the area of these trapezoids. This is not limited to trapezoids and could also be computed using rectangle (e.g. in the Matlab <a href="https://www.mathworks.com/help/signal/ref/bandpower.html"
            target="_blank">bandpower</a> function).</p>

        <pre><code class="python"># Compute the absolute power by approximating the area under the curve
delta_power = np.trapz(psd[idx_delta], freqs[idx_delta])
print('Absolute delta power: %.3f V^2' % delta_power)
</code></pre>

        <blockquote><b>Absolute &delta; power:</b> 313.026 volts-squared</blockquote>

        <h5>Relative power</h5>

        <p align="justify">In practice, rather than reporting the absolute band power, one may want to express the power in a frequency band as a percentage of the total power of the signal. This is called the relative band power. It can be calculated very easily from the above:</p>

        <pre><code class="python"># Relative delta power (expressed as a percentage of total power)
total_power = np.trapz(psd, freqs)
delta_rel_power = delta_power / total_power
print('Relative delta power: %.3f' % delta_rel_power)
</code></pre>

        <blockquote><b>Relative &delta; power:</b> 0.769</blockquote>

        <p align="justify">In other words, 76.9% of the total power of the signal is contained in the delta frequency band.</p>

        <blockquote><b>Relative &delta; power:</b> 0.769</blockquote>

        <hr />

        <h4>Generalization</h4>

        <p align="justify">The function below is a generalization of the above which can be used to easily get the average absolute or relative power in a specific frequency band. It is very similar to the Matlab <a href="https://www.mathworks.com/help/signal/ref/bandpower.html"
            target="_blank">bandpower</a> function, the two main differences being that it uses a Welch's periodogram instead of a classical periodogram, and trapezoids instead of rectangle to approximate the area.</p>

        <pre><code class="python">def bandpower(data, sf, band, window_sec=None, relative=False):
    """Compute the average power of the signal x in a specific frequency band.

    Parameters
    ----------
    data : 1d-array
        Input signal in the time-domain.
    sf : float
        Sampling frequency of the data.
    band : list
        Lower and upper frequencies of the band of interest.
    window_sec : float
        Length of each window in seconds.
        If None, window_sec = (1 / min(band)) * 2
    relative : boolean
        If True, return the relative power (= divided by the total power of the signal).
        If False (default), return the absolute power.

    Return
    ------
    bp : float
        Absolute or relative band power.

    Examples
    ------
    1. Absolute and relative power in the delta band
        >>> delta = bandpower(data, 100, [0.5, 4])
        >>> delta_relative = bandpower(data, 100, [0.5, 4], relative=True)

    2. Delta / beta ratio
        >>> window_sec = 4
        >>> delta = bandpower(data, 100, [0.5, 4], window_sec)
        >>> beta = bandpower(data, 100, [12, 30], window_sec)
        >>> db_ratio = delta / beta
    """
    from scipy.signal import welch
    band = np.asarray(band)
    low, high = band

    # Compute the modified periodogram (Welch)
    if window_sec is not None:
        nperseg = window_sec * sf
    else:
        nperseg = (2 / low) * sf

    freqs, psd = welch(data, sf, nperseg=nperseg, scaling='density')

    # Find closest indices of band in frequency vector
    idx_min = np.argmax(freqs > low) - 1
    idx_max = np.argmax(freqs > high) - 1
    idx_band = np.zeros(dtype=bool, shape=freqs.shape)
    idx_band[idx_min:idx_max] = True

    # Integral approximation of the spectrum using the trapezoid rule
    bp = np.trapz(psd[idx_band], freqs[idx_band])

    if relative:
        bp /= np.trapz(psd, freqs)
    return bp
</code></pre>

<hr />

<h4>Ratio  between two frequency bands</h4>

<p align="justify">It is also very common to report the ratios between two frequency bands. For instance, the delta / beta ratio is a well-known index of slow-wave sleep quality. When computing ratios between two bands, it is important to control that the window_length of the periodogram is the same for the two bands. Indeed, if you are using a different window length for the two bands, this will result in two different periodograms and the ratio will therefore be meaningless.</p>

<pre><code class="python"># Define the duration of the window to be 4 seconds
win = 4

# Delta/beta ratio based on the absolute power
db = bandpower(data, sf, [0.5, 4], win) / bandpower(data, sf, [12, 30], win)

# Delta/beta ratio based on the relative power
db_rel = bandpower(data, sf, [0.5, 4], win, True) / bandpower(data, sf, [12, 30], win, True)
</code></pre>

<blockquote><b>&delta;/&beta; ratio (absolute)</b>: 41.044<br>
<b>&delta;/&beta; ratio (relative)</b>: 41.044</blockquote>

<hr />

<p align="justify">I hope that this guide was useful! In the next part, we'll see how to use <b>multitaper</b> power spectral density estimate to improve the accuracy of the band power. In the meantime, feel free to <a href="mailto:raphaelvallat9@gmail.com">write to me</a> if you have any questions.</p>


      </div>

      <!-- Footer -->
      <section id="footer">
        <div class="container">
          <ul class="copyright">
            <li>&copy; Raphael Vallat </li>
            <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
            <li>Banner image: Nicholas Roerich</li>
          </ul>
        </div>
      </section>

    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.scrollzer.min.js"></script>
    <script src="assets/js/jquery.scrolly.min.js"></script>
    <script src="assets/js/skel.min.js"></script>
    <script src="assets/js/util.js"></script>
    <!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
    <script src="assets/js/main.js"></script>

</body>

</html>
