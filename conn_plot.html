<!DOCTYPE HTML>
<!--
	Read Only by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html>
	<head>
		<title>Raphael Vallat</title>
		<meta charset="utf-8" />
		<meta name="description" content="Personal website of Raphael Vallat" />
		<meta name="author" content="Raphael Vallat">
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
	</head>
	<body>

		<!-- Header -->
			<section id="header">
				<header>
					<span class="image avatar"><img src="images/avatar.jpg" alt="" /></span>
					<h1 id="logo"><a href="#">Raphael Vallat</a></h1>
					<p>PhD student in Neuroscience <br> Lyon Neuroscience Research Center</p>
				</header>
				<nav id="nav">
					<ul>
						<li><a href="index.html#one">About</a></li>
						<li><a href="index.html#two">Academics</a></li>
						<li><a href="index.html#three">Publications</a></li>
						<li><a href="index.html#four" class="active">Tutorials</a></li>
					</ul>
				</nav>
				<footer>
					<ul class="icons">
						<!-- <li><a href="#" class="icon fa-twitter"><span class="label">Twitter</span></a></li> -->
						<!-- <li><a href="#" class="icon fa-facebook"><span class="label">Facebook</span></a></li> -->
						<!-- <li><a href="#" class="icon fa-instagram"><span class="label">Instagram</span></a></li> -->
						<li><a href="https://github.com/raphaelvallat" class="icon fa-github"><span class="label">Github</span></a></li>
						<li><a href="mailto:raphael.vallat@inserm.fr" class="icon fa-envelope"><span class="label">Email</span></a></li>
					</ul>
				</footer>
			</section>

		<!-- Wrapper -->
			<div id="wrapper">

				<!-- Main -->
					<div id="main">
					
					<div class="container">


						<header>
							<h4>CONN Toolbox</h4>
							<h3>Extract and plot ROI-to-ROI connectivity matrix</h3>
						</header>
						
						
						<p align="justify">The <a href="https://www.nitrc.org/projects/conn"> CONN toolbox </a> is a very efficient MATLAB-based tool to perform functional connectivity analysis and I've been an enthusiastic user ever since I discovered it. It provides a robust analysis pipeline from raw files to second-level adavanced statistical results as well as a very nice and intuitive GUI - making it one of the best fcMRI toolbox for both beginner and expert. I worked a great deal with it for ROI-to-ROI analysis of within and between network connectivity. One feature that is not (yet) implemented in CONN is the possibility to plot a graphical representation of network connectivity matrix. The purpose of this tutorial is therefore to show how to extract (and export to CSV) connectivity matrix from CONN results folder and then plot them using either Matlab or Python.
						
						<ul class="feature-icons"><li class="fa-code">A full version of the MATLAB scripts used can be found on my <a href="https://github.com/raphaelvallat/conn_correl_mat">GitHub repository</a></li></ul>
						

						<span class="image fit"><img src="images/tutorials/conn_correl_mat/correl_mat.png" alt="" />
						<figcaption>Salience network connectivity matrices (beta, T and p-values)</figcaption>
						</span>
						
						<hr />
						
						<h4>ROI.mat structure</h4>

						<p align="justify">CONN ROI.mat file is created when clicking "Results Explorer" in the bottom left of the CONN 2nd-level interface. This MAT structure can be found in the folder <i>/results/secondlevel/FIRSTLEVEL_NAME/GROUP/SESSION/</i> and contains the following fields <a href="https://www.nitrc.org/forum/message.php?msg_id=15500">(see this post)</a></p>
						
						<li><b>names:</b> names of the source ROIs</li>
						<li><b>h:</b> beta values displayed in CONN 2nd-level interface, which corresponds to the  average Fischer transformed pairwise correlations of specified contrast</li>
						<li><b>F:</b> statistical values, depending on the statistical test (see statsname field)</li>
						<li><b>p:</b> one-tailed p-values</li>

						<hr />
			
						<h4>Extracting connectivity matrix</h4>
						<p>The following code extract all the pairwise correlations in the ROI.mat file </p>

<pre><code>
% Define analysis path
wdir 		= 'C:\Users\Raphael\Desktop\These\conn_example\results\secondlevel';
corr_net 	= 'Salience';
corr_group 	= 'AllSubjects';
corr_run 	= 'rest';
corr_folder = [ wdir '\' corr_net '\' corr_group '\' corr_run '\' ];

load([corr_folder 'ROI.mat']);        

numROI  	= size(ROI, 2);
corr_name 	= ROI(1).names(1:numROI);

corr_h   	= [];   % Beta value
corr_F  	= [];   % Statistic value
corr_p   	= [];   % One-tailed p value

for i = 1:numROI
	corr_h = [ corr_h ; ROI(i).h(1:numROI) ];
	corr_F = [ corr_F ; ROI(i).F(1:numROI) ];
	corr_p = [ corr_p ; ROI(i).p(1:numROI) ];
end			
</code></pre>

						<hr />
													
						<h4>Export to CSV</h4>
						<p>Now we can export it to CSV file (by default in the same folder as ROI.mat file</p>
<pre><code>
corr_name2 	= strrep(corr_name, '-', '_');      % array2table does not work with '-' in var names
T_h        	= array2table(corr_h, 'RowNames', corr_name2, 'VariableNames', corr_name2);
T_F        	= array2table(corr_F, 'RowNames', corr_name2, 'VariableNames', corr_name2);
T_p        	= array2table(corr_p, 'RowNames', corr_name2, 'VariableNames', corr_name2);

writetable( T_h, [corr_folder 'beta_' corr_net '_' corr_group '_' corr_run '.csv'], 'WriteVariableNames', true, 'WriteRowNames', true, 'delimiter', 'semi' );
writetable( T_F, [corr_folder 'F_' corr_net '_' corr_group '_' corr_run '.csv'], 'WriteVariableNames', true, 'WriteRowNames', true, 'delimiter', 'semi');
writetable( T_p, [corr_folder 'p_' corr_net '_' corr_group '_' corr_run '.csv'], 'WriteVariableNames', true, 'WriteRowNames', true, 'delimiter', 'semi');
</code></pre>
													
						<hr />
						
						<h4>Statistics</h4>
						<p>The following lines compute uncorrected, bonferroni and FDR-corrected p-values</p>
<pre><code>
anti_corr_net = False;

# Case two or several anti-correlated networks (ex: Default and Dorsal Attention)
if anti_corr_net 	
    tail      = 'two-sided';
    corr_p    = 2*min(corr_info.corr_p, 1-corr_info.corr_p);

# Case single network
else		
    tail      = 'one-sided';
    
end

% Compute Bonferroni and FDR correction
% conn_fdr function is in conn main folder
alpha_bonf            			= 0.05 / ((numROI)*(numROI-1)/2);
vector_fdr                      = nonzeros(triu(corr_info.corr_p)');
vector_fdr(isnan(vector_fdr))   = [];
corr_p_fdr            			= conn_fdr(vector_fdr); 

% WRITE OUTPUT
fprintf('\nANALYSIS INFO');
fprintf('\n--------------------------------------');
fprintf(['\nNetwork:\t ' corr_net]);
fprintf(['\nGroup:\t\t ' corr_group]);
fprintf(['\nRun:\t\t ' corr_run]);
fprintf('\nSTATISTICS');
fprintf('\n--------------------------------------');
fprintf([ '\n' num2str(numROI) ' x ' num2str(numROI-1) ' ROIs matrix ; ' tail]);
fprintf([ '\np-uncorrected:\t\t\t\t\t ' num2str(numel(corr_p(corr_p <= 0.05))/2)  ]);
fprintf([ '\np-bonferroni (alpha = ' num2str(round(alpha_bonf, 5)) '):\t ' num2str(numel(corr_p(corr_p <= alpha_bonf))/2) ]);
fprintf([ '\np-FDR corrected:\t\t\t\t ' num2str(numel(corr_p_fdr(corr_p_fdr <= 0.05))) ]);
fprintf('\n--------------------------------------\n');
</code></pre>

<h5>MATLAB Output:</h5>				
<pre>
ANALYSIS INFO
--------------------------------------
Network:	 DMN
Group:		 Controls(1).Patients(-1)
Run:		 rest
STATISTICS
--------------------------------------
5 x 4 ROIs matrix ; one-sided
p-uncorrected:                  4
p-bonferroni (alpha = 0.005):   1
p-FDR corrected:                1
--------------------------------------
</pre>	
						<hr />
						<h4>Plotting brain connectivity matrix</h4>
						<p align="justify">Once we extracted and exported the connectivity matrix in text format, we can plot it using Matlab imagesc command.I will detail here for beta values (corr_h) but if you want to plot F or p values you can check the full script on my <a href="https://github.com/raphaelvallat/conn_correl_mat">GitHub repository</a></p>
						
<pre><code>
% Remove upper triangle + diagonal
corr = tril(corr, -1)


% Start plotting
fig = figure;
set(gcf,'Units','inches', 'Position',[0 0 6 4])

im = imagesc(corr, clim );

clim = [ 0 1 ];
colormap(flipud(hot(10)));

h = colorbar('eastoutside');
xlabel(h, 'h', 'FontSize', 14);


% Title, axis
title('Salience Network', 'FontSize', 14);
set(gca, 'XTick', (1:numROI));
set(gca, 'YTick', (1:numROI));
set(gca, 'Ticklength', [0 0])
grid off
box off

% Labels
set(gca, 'XTickLabel', corr_name, 'XTickLabelRotation', 0);
set(gca, 'YTickLabel', corr_name);
</code></pre>
						
						<span class="image fit"><img src="images/tutorials/conn_correl_mat/Salience.png" alt="" /></span>

						<hr />
						
						<p>With some adaptation, the previous code also works for between-network connectivity matrix  (blue denotes negative correlations)</p>
						
						<span class="image fit"><img src="images/tutorials/conn_correl_mat/ACN.png" alt="" /></span>
						
						<hr />
						
						<h4>Plotting with Python</h4>
						<p>The previous connectivity matrices can be plot very easily using the amazing <a href="http://seaborn.pydata.org/index.html">Seaborn visualization library</a> for Python</p>
						
						<span class="image fit"><img src="images/tutorials/conn_correl_mat/python_corr_mat.png" alt="" /></span>
						
<pre><code>
import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import os

sns.set(style="white", context='paper', font_scale=1)

wdir = "C:/Users/Raphael/Desktop/These/conn_example/results/secondlevel"

# ANALYSIS INFO
corr_net    = 'Salience'
corr_group  ='AllSubjects'
corr_run    = 'rest'
corr_type   = 'beta'
corr_folder = os.path.join(wdir, corr_net, corr_group, corr_run )

corr        = pd.read_csv(os.path.join(corr_folder, corr_type + '_' + corr_net + '_' + corr_group + '_' + corr_run + '.csv'), sep=';', index_col=0, decimal='.')

# Remove upper triangle
mask = np.zeros_like(corr, dtype=np.bool)                                  
mask[np.triu_indices_from(mask, k=0)] = True
    
# Plot
f, ax = plt.subplots()

# Case: Single Network
sns.heatmap(corr, mask=mask, vmin=0, vmax=1, cmap="YlOrRd", square=True, annot=True, cbar=True, xticklabels=True, yticklabels=True )

# Case: Multiple Networks
sns.heatmap(corr, mask=mask, vmin=-0.8, vmax=0.8, cmap="RdBu_r", square=True, annot=False, cbar=True, xticklabels=True, yticklabels=True )

#....Emphasize networks separation (comment this block if single network)
# see http://seaborn.pydata.org/examples/network_correlations.html
networks = np.array(pd.read_csv(os.path.join(corr_folder, 'networks_level_values.csv')))
for i, network in enumerate(networks):
    if i and network != networks[i - 1 ]:
        ax.axhline(len(networks) - i, c="w")
        ax.axvline(i, c="w")
f.tight_layout()

plt.ylabel('')
plt.xticks(rotation=0) 

plt.savefig(os.path.join(corr_folder, 'correl_mat.png')), dpi=300)
</code></pre>			
	
				</div>

				<!-- Footer -->
					<section id="footer">
						<div class="container">
							<ul class="copyright">
								<li>&copy; Raphael Vallat </li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li><li>Banner image: Nicolas Roerich</li>
							</ul>
						</div>
					</section>

			</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrollzer.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>

	</body>
</html>